import React, { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import "../Style.css";
import pdfMake from "pdfmake/build/pdfmake.min";
import pdfFonts from "pdfmake/build/vfs_fonts";

import { getInventory, createInventoryItem, updateInventoryItem, deleteInventoryItem } from "../api/inventory";
import { getJobOrders, createJobOrder, updateJobOrder, deleteJobOrder } from "../api/jobOrders";
import { getDashboardStats } from "../api/dashboard";
import { clearAuth } from "../utils/auth";
import { logout as logoutAPI } from "../api/auth";
pdfMake.vfs = pdfFonts.vfs;

function AdminDashboard() {
  const navigate = useNavigate();

  const formatJobOrderNo = (num) => String(num).padStart(4, "0");

  const [activeTab, setActiveTab] = useState("dashboard");
  const [products, setProducts] = useState([]);
  const [jobOrders, setJobOrders] = useState([]);
  const [dashboardStats, setDashboardStats] = useState(null);
  const [loading, setLoading] = useState(true);

  // JOB ORDER STATES
  const [showJobOrderModal, setShowJobOrderModal] = useState(false);
  const [editJobId, setEditJobId] = useState(null);
  const [jobStatusFilter, setJobStatusFilter] = useState("All");
  const [isJobReadOnly, setIsJobReadOnly] = useState(false);
  const [inventorySearch, setInventorySearch] = useState("");
  const [jobSearch, setJobSearch] = useState("");
  const [salesDate, setSalesDate] = useState("");
  const [salesStartDate, setSalesStartDate] = useState("");
  const [salesEndDate, setSalesEndDate] = useState("");
  const [salesLogDate, setSalesLogDate] = useState("");

  // form fields
  const [jobOrderNo, setJobOrderNo] = useState(0);
  const [clientName, setClientName] = useState("");
  const [vehicleModel, setVehicleModel] = useState("");
  const [plateNumber, setPlateNumber] = useState("");
  const [customerType, setCustomerType] = useState("");
  const [contactNumber, setContactNumber] = useState("");
  const [dateIn, setDateIn] = useState("");
  const [dateRelease, setDateRelease] = useState("");
  const [assignedTo, setAssignedTo] = useState("");
  const [status, setStatus] = useState("Pending");
  const [address, setAddress] = useState("");
  const [services, setServices] = useState([{ description: "", qty: "", unit: "", price: "", unitPrice: "" }]);
  const [parts, setParts] = useState([{ description: "", qty: "", unit: "", price: "", unitPrice: "" }]);

  const [subtotal, setSubtotal] = useState(0);
  const [discount, setDiscount] = useState("");
  const [grandTotal, setGrandTotal] = useState(0);

  // Load data from API
  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    setLoading(true);
    try {
      const [inventoryRes, jobOrdersRes, dashboardRes] = await Promise.all([
        getInventory(),
        getJobOrders(),
        getDashboardStats(),
      ]);

      if (inventoryRes.success) {
        setProducts(inventoryRes.data);
      }
      if (jobOrdersRes.success) {
        setJobOrders(jobOrdersRes.data);
        // Set next job order number
        if (jobOrdersRes.data.length > 0) {
          const maxNo = Math.max(
            ...jobOrdersRes.data.map(j =>
              parseInt(j.job_order_no || j.joNumber || 0, 10)
            )
          );
          setJobOrderNo(maxNo + 1);
        } else {
          setJobOrderNo(0); // Start from 0000 for the first job order
        }

      }
      if (dashboardRes.success) {
        setDashboardStats(dashboardRes.data);
      }
    } catch (error) {
      console.error('Error loading data:', error);
      alert('Failed to load data. Please refresh the page.');
    } finally {
      setLoading(false);
    }
  };

  // compute totals
  const calculateTotals = () => {
    const serviceTotal = services.reduce((sum, s) => {
      const total = parseFloat(s.price) || 0;
      return sum + total;
    }, 0);

    const partsTotal = parts.reduce((sum, p) => {
      const total = parseFloat(p.price) || 0;
      return sum + total;
    }, 0);

    const total = serviceTotal + partsTotal;
    const discountValue = parseFloat(discount);
    const discountAmount = Number.isNaN(discountValue) ? 0 : discountValue;

    setSubtotal(total);
    setGrandTotal(total - discountAmount);
  };

  useEffect(() => {
    calculateTotals();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [services, parts, customerType, discount]);

  const getOrderDate = (order) => order.dateIn || order.date || "";
  const toDateKey = (dateStr) => {
    if (!dateStr) return "";
    return dateStr.slice(0, 10);
  };

  const computeOrderTotals = (order) => {
    const servicesList = order.services || [];
    const partsList = order.parts || [];

    const totalLabor = servicesList.reduce((sum, s) => sum + (parseFloat(s.price) || 0), 0);
    const totalPartsPrice = partsList.reduce((sum, p) => sum + (parseFloat(p.price) || 0), 0);

    let unitPriceTotal = 0;
    partsList.forEach((p) => {
      const qty = parseFloat(p.qty) || 0;
      const code = (p.description || "").split(" - ")[0]?.trim();
      const product = products.find(prod => prod.code?.toLowerCase() === (code || "").toLowerCase());
      if (product) {
        const unitCost = parseFloat(product.price) || 0;
        unitPriceTotal += unitCost * qty;
      }
    });

    const discountValue = parseFloat(order.discount) || 0;
    const totalAmount = totalLabor + totalPartsPrice - discountValue;
    const profit = totalPartsPrice - unitPriceTotal;

    return { totalLabor, totalPartsPrice, unitPriceTotal, totalAmount, profit, discountValue };
  };

  const completedOrders = jobOrders.filter(o => o.status === "Completed");
  const salesByDate = salesDate
    ? completedOrders.filter(o => toDateKey(getOrderDate(o)) === salesDate)
    : [];
  const salesByRange = salesStartDate && salesEndDate
    ? completedOrders.filter(o => {
      const key = toDateKey(getOrderDate(o));
      return key >= salesStartDate && key <= salesEndDate;
    })
    : [];

  const totalSalesByDate = salesByDate.reduce((sum, o) => {
    const totals = computeOrderTotals(o);
    return sum + totals.totalAmount;
  }, 0);
  const totalProfitByDate = salesByDate.reduce((sum, o) => {
    const totals = computeOrderTotals(o);
    return sum + totals.profit;
  }, 0);

  const totalSalesByRange = salesByRange.reduce((sum, o) => {
    const totals = computeOrderTotals(o);
    return sum + totals.totalAmount;
  }, 0);
  const totalProfitByRange = salesByRange.reduce((sum, o) => {
    const totals = computeOrderTotals(o);
    return sum + totals.profit;
  }, 0);

  const totalProfit = completedOrders.reduce((sum, o) => {
    const totals = computeOrderTotals(o);
    return sum + totals.profit;
  }, 0);

  const filteredSalesOrders = salesLogDate
    ? completedOrders.filter(o => toDateKey(getOrderDate(o)) === salesLogDate)
    : completedOrders;

  const getCustomerMultiplier = (type) => {
    const vat = 1.12;
    if (type === "LGU") return 1.60 * vat;
    if (type === "STAN") return 1.30 * vat;
    return 1.25 * vat; // Private default
  };

  // add / update / delete service rows
  const addServiceRow = () => {
    setServices((prev) => [...prev, { description: "", qty: "", unit: "", price: "" }]);
  };
  const updateService = (index, field, value) => {
    setServices(prev => {
      const copy = [...prev];
      const currentRow = { ...copy[index] };

      // Replace 0 with first typed value
      if (field === "price" && (currentRow.price === "0" || currentRow.price === 0)) {
        currentRow.price = value;
      } else {
        currentRow[field] = value;
      }

      // Store unit price
      if (field === "price") {
        if (value === "") {
          currentRow.unitPrice = "";
          currentRow.price = "";
        } else {
          const qty = parseFloat(currentRow.qty) || 0;
          const unit = parseFloat(value) || 0;
          currentRow.unitPrice = value;
          currentRow.price = (qty * unit).toFixed(2); // update total
        }
      }

      // Update total if qty changes
      if (field === "qty") {
        const qty = parseFloat(value) || 0;
        const unit = parseFloat(currentRow.unitPrice);
        if (currentRow.unitPrice === "" || Number.isNaN(unit)) {
          currentRow.price = "";
        } else {
          currentRow.price = (qty * unit).toFixed(2);
        }
      }

      copy[index] = currentRow;
      return copy;
    });
  };

  const deleteService = (index) => {
    setServices((prev) => {
      if (prev.length <= 1) return prev;
      return prev.filter((_, i) => i !== index);
    });
  };

  // parts row handlers
  const addPartRow = () => {
    setParts((prev) => [...prev, { description: "", qty: "", unit: "", price: "", unitPrice: "" }]);
  };
  const updatePart = (index, field, value, options = {}) => {
    setParts(prev => {
      const copy = [...prev];
      const currentRow = { ...copy[index] };
      const wasBlank = !currentRow.description?.trim() && !currentRow.unit?.trim() && !currentRow.qty && !currentRow.unitPrice && !currentRow.price;

      if (field === "price" && (currentRow.price === "0" || currentRow.price === 0)) {
        currentRow.price = value;
      } else {
        currentRow[field] = value;
      }

      // AUTO-FILL UNIT PRICE ONLY WHEN ENTER IS PRESSED
      if (field === "description" && options.commit === true) {
        const product = products.find(
          p => p.code?.toLowerCase() === value.trim().toLowerCase()
        );

        if (product) {
          const baseUnit = parseFloat(product.price || 0);
          const multiplier = getCustomerMultiplier(customerType);
          const unit = baseUnit * multiplier;
          const qty = parseFloat(currentRow.qty) || 0;
          currentRow.description = `${product.code} - ${product.name}`;
          currentRow.baseUnitPrice = String(baseUnit);
          currentRow.unitPrice = unit.toFixed(2);
          currentRow.price = (qty * unit).toFixed(2);

          // If user scanned into the last blank row, add a new blank row for the next scan
          if (index === copy.length - 1 && wasBlank) {
            copy.push({ description: "", qty: "", unit: "", price: "", unitPrice: "" });
          }
        }
      }

      // Store unit price and update total when unit price changes
      if (field === "price") {
        if (value === "") {
          currentRow.unitPrice = "";
          currentRow.price = "";
        } else {
          const qty = parseFloat(currentRow.qty) || 0;
          const unit = parseFloat(value) || 0;
          currentRow.unitPrice = value;
          currentRow.price = (qty * unit).toFixed(2);
        }
      }

      // Update total if qty changes
      if (field === "qty") {
        const qty = parseFloat(value) || 0;
        const unit = parseFloat(currentRow.unitPrice);
        if (currentRow.unitPrice === "" || Number.isNaN(unit)) {
          currentRow.price = "";
        } else {
          currentRow.price = (qty * unit).toFixed(2);
        }
      }

      copy[index] = currentRow;
      return copy;
    });
  };

  useEffect(() => {
    setParts(prev => prev.map(p => {
      if (!p.baseUnitPrice) return p;
      const baseUnit = parseFloat(p.baseUnitPrice) || 0;
      const multiplier = getCustomerMultiplier(customerType);
      const unit = baseUnit * multiplier;
      const qty = parseFloat(p.qty) || 0;
      return {
        ...p,
        unitPrice: unit.toFixed(2),
        price: p.unitPrice === "" && p.price === "" ? "" : (qty * unit).toFixed(2)
      };
    }));
  }, [customerType]);


  const deletePart = (index) => {
    setParts((prev) => {
      if (prev.length <= 1) return prev;
      return prev.filter((_, i) => i !== index);
    });
  };

  const isJobFormValid = () => {
    if (!clientName.trim() || !customerType || !dateIn || !assignedTo.trim()) return false;

    const isServiceRowBlank = (s) =>
      !s.description?.trim() && !s.unit?.trim() && (!s.qty || s.qty === "0") && (!s.unitPrice || s.unitPrice === "0") && (!s.price || s.price === "0");

    const isPartRowBlank = (p) =>
      !p.description?.trim() && !p.unit?.trim() && (!p.qty || p.qty === "0") && (!p.unitPrice || p.unitPrice === "0") && (!p.price || p.price === "0");

    for (const s of services) {
      if (isServiceRowBlank(s)) continue;
      if (!s.description?.trim() || !s.unit?.trim() || !s.qty || s.price === "" || isNaN(parseFloat(s.price))) return false;
    }

    for (const p of parts) {
      if (isPartRowBlank(p)) continue;
      if (!p.description?.trim() || !p.unit?.trim() || !p.qty || p.price === "" || isNaN(parseFloat(p.price))) return false;
    }

    return true;
  };

  const persistJobOrder = async (statusOverride = null) => {
    if (!isJobFormValid()) return;

    const orderData = {
      client: clientName,
      address,
      vehicleModel,
      contactNumber,
      plate: plateNumber,
      customerType,
      assignedTo,
      dateIn,
      dateRelease: dateRelease || null,
      status: statusOverride || status,
      services,
      parts,
      subtotal,
      discount,
      total: grandTotal,
    };

    // If editing, include id and joNumber
    if (editJobId !== null) {
      const existingJob = jobOrders.find(j => j.id === editJobId);
      orderData.id = editJobId;
      orderData.joNumber = existingJob?.joNumber || existingJob?.job_order_no;
    }

    try {
      let result;
      if (editJobId !== null) {
        result = await updateJobOrder(orderData);
      } else {
        result = await createJobOrder(orderData);
      }

      if (result.success) {
        await loadData(); // Reload data
        resetJobForm();
        setShowJobOrderModal(false);
        setEditJobId(null);
      } else {
        alert(result.error || 'Failed to save job order');
      }
    } catch (error) {
      console.error('Error saving job order:', error);
      alert('Failed to save job order. Please try again.');
    }
  };

  // save job order - API call
  const saveJobOrder = async () => {
    await persistJobOrder();
  };

  const handleDeleteJobOrder = async (jobId) => {
    if (!window.confirm('Are you sure you want to delete this job order?')) return;

    try {
      const result = await deleteJobOrder(jobId);
      if (result.success) {
        await loadData();
      } else {
        alert(result.error || 'Failed to delete job order');
      }
    } catch (error) {
      console.error('Error deleting job order:', error);
      alert('Failed to delete job order. Please try again.');
    }
  };

  const resetJobForm = () => {
    setClientName("");
    setVehicleModel("");
    setPlateNumber("");
    setCustomerType("");
    setContactNumber("");
    setDateIn("");
    setDateRelease("");
    setAssignedTo("");
    setStatus("Pending");
    setAddress("");
    setServices([{ description: "", qty: "", unit: "", price: "", unitPrice: "" }]);
    setParts([{ description: "", qty: "", unit: "", price: "", unitPrice: "" }]);
    setSubtotal(0);
    setDiscount("");
    setGrandTotal(0);
    setIsJobReadOnly(false);
  };

  // handle edit
  const handleEditJob = (jobId) => {
    const job = jobOrders.find(j => j.id === jobId);
    if (!job) return;

    const normalizedServices = job.services && job.services.length > 0
      ? job.services.map((s) => ({
          description: s.description ?? "",
          unit: s.unit ?? "",
          qty: s.qty ?? s.quantity ?? "",
          price: s.price ?? "",
          unitPrice: s.unitPrice ?? s.unit_price ?? s.price ?? "",
        }))
      : [{ description: "", unit: "", qty: "", price: "", unitPrice: "" }];

    const normalizedParts = job.parts && job.parts.length > 0
      ? job.parts.map((p) => ({
          description: p.description ?? "",
          unit: p.unit ?? "",
          qty: p.qty ?? p.quantity ?? "",
          price: p.price ?? "",
          unitPrice: p.unitPrice ?? p.unit_price ?? p.price ?? "",
        }))
      : [{ description: "", qty: "", unit: "", price: "", unitPrice: "" }];

    setEditJobId(jobId);
    setIsJobReadOnly(job.status === "Completed");
    setClientName(job.client || job.customer_name || "");
    setVehicleModel(job.vehicleModel || job.model || "");
    setPlateNumber(job.plate || job.plate_no || "");
    setCustomerType(job.customerType || job.type || "Private");
    setAddress(job.address || "");
    setContactNumber(job.contactNumber || job.contact_no || "");
    setDateIn(job.dateIn || job.date || "");
    setDateRelease(job.dateRelease || job.date_release || "");
    setAssignedTo(job.assignedTo || job.assigned_to || "");
    setStatus(job.status || "Pending");
    setServices(normalizedServices);
    setParts(normalizedParts);
    setSubtotal(parseFloat(job.subtotal || 0));
    setDiscount(job.discount === null || job.discount === undefined ? "" : String(job.discount));
    setGrandTotal(parseFloat(job.total || job.total_amount || 0));
    setShowJobOrderModal(true);
  };

  // PRODUCT STATES
  const [showModal, setShowModal] = useState(false);
  const [newProduct, setNewProduct] = useState({ code: "", partNumber: "", name: "", quantity: "", price: "", srp: "", companyCodename: "" });
  const [editProductId, setEditProductId] = useState(null);
  const [isEditModal, setIsEditModal] = useState(false);

  const logoSrc = process.env.PUBLIC_URL + "/HeaderLogo.png";

  const isFormValid = () => newProduct.name.trim() !== "" && newProduct.quantity !== "" && newProduct.price !== "";

  // ADD PRODUCT HANDLER
  const handleAddProduct = async () => {
    if (!isFormValid()) return;

    // Check for duplicate before saving
    const existing = products.find(p => p.code === newProduct.code.trim());
    if (existing) {
      alert(`Item with code "${newProduct.code}" is already in the inventory (Product: ${existing.name}).`);
      return;
    }

    try {
      const result = await createInventoryItem({
        name: newProduct.name,
        quantity: parseInt(newProduct.quantity),
        price: parseFloat(newProduct.price),
        companyCodename: newProduct.companyCodename,
        code: newProduct.code,
        partNumber: newProduct.partNumber
      });

      if (result.success) {
        await loadData();
        setNewProduct({ code: "", partNumber: "", name: "", quantity: "", price: "", srp: "", companyCodename: "" });
        setShowModal(false);
      } else {
        alert(result.error || 'Failed to add product');
      }
    } catch (error) {
      console.error('Error adding product:', error);
      alert('Failed to add product. Please try again.');
    }
  };

  const openEditModal = (productId) => {
    const p = products.find(prod => prod.id === productId);
    if (!p) return;
    setEditProductId(productId);
    setIsEditModal(true);
    setNewProduct({ code: p.code, partNumber: p.part_number || p.partNumber || "", name: p.name, quantity: p.stocks, price: p.price, srp: p.srp, companyCodename: p.company_codename });
  };

  const handleSaveEdit = async () => {
    if (!isFormValid()) return;

    try {
      const result = await updateInventoryItem({
        id: editProductId,
        code: newProduct.code,
        name: newProduct.name,
        quantity: parseInt(newProduct.quantity),
        price: parseFloat(newProduct.price),
        companyCodename: newProduct.companyCodename,
        partNumber: newProduct.partNumber
      });

      if (result.success) {
        await loadData();
        setIsEditModal(false);
        setEditProductId(null);
        setNewProduct({ code: "", partNumber: "", name: "", quantity: "", price: "", srp: "", companyCodename: "" });
      } else {
        alert(result.error || 'Failed to update product');
      }
    } catch (error) {
      console.error('Error updating product:', error);
      alert('Failed to update product. Please try again.');
    }
  };

  const handleDeleteProduct = async (productId) => {
    if (!window.confirm('Are you sure you want to delete this product?')) return;

    try {
      const result = await deleteInventoryItem(productId);
      if (result.success) {
        await loadData();
      } else {
        alert(result.error || 'Failed to delete product');
      }
    } catch (error) {
      console.error('Error deleting product:', error);
      alert('Failed to delete product. Please try again.');
    }
  };

  const handleLogout = async () => {
    try {
      const token = localStorage.getItem('token');
      if (token) {
        await logoutAPI(token);
      }
    } catch (error) {
      console.error('Logout error:', error);
    } finally {
      clearAuth();
      navigate('/login');
    }
  };

  const exportJobOrderPDF = async () => {
    const logoBase64 = await loadBase64Image(process.env.PUBLIC_URL + "/AutronicasLogo.png");
    const currentJob = editJobId !== null ? jobOrders.find(j => j.id === editJobId) : null;
    const rawJobNo = currentJob?.joNumber ?? currentJob?.job_order_no ?? jobOrderNo;
    const formattedJobNo = formatJobOrderNo(rawJobNo);
    const shouldComplete = status !== "Completed";

    const jobData = {
      joNumber: formattedJobNo,
      client: clientName,
      address,
      vehicleModel,
      plateNumber,
      dateIn,
      dateRelease,
      customerType,
      assignedTo,
      contactNumber,
      subtotal,
      discount,
      grandTotal,
      services,
      parts
    };

    const serviceRows = jobData.services.map(s => ([
      { text: s.description, fontSize: 10 },
      { text: s.qty, alignment: "center", fontSize: 10 },
      { text: s.unit, alignment: "center", fontSize: 10 },
      { text: Number(s.price).toFixed(2), alignment: "right", fontSize: 10 },
      { text: (parseFloat(s.qty) * parseFloat(s.price)).toFixed(2), alignment: "right", fontSize: 10 }
    ]));

    const partsRows = jobData.parts.map(p => ([
      { text: p.description, fontSize: 10 },
      { text: p.qty, alignment: "center", fontSize: 10 },
      { text: p.unit || "", alignment: "center", fontSize: 10 },
      { text: Number(p.price).toFixed(2), alignment: "right", fontSize: 10 },
      { text: (parseFloat(p.qty) * parseFloat(p.price)).toFixed(2), alignment: "right", fontSize: 10 }
    ]));

    const docDefinition = {
      pageSize: "LETTER",
      pageMargins: [40, 110, 40, 120],
      header: {
        margin: [40, 20, 40, 0],
        stack: [
          { image: logoBase64, width: 120, alignment: "center", margin: [0, 0, 0, 2] },
          { text: "AUTO SERVICE AND SPARE PARTS CORP.", style: "header", alignment: "center", color: "#0b5ed7" },
          { text: "MAHARLIKA HIGHWAY SITIO BAGONG TULAY BRGY. BUKAL PAGBILAO QUEZON", style: "subheader", alignment: "center", color: "#0b5ed7" },
          { text: "SMART: 09989990252   GLOBE: 09171874571", style: "subheader", alignment: "center", margin: [0, 0, 0, 10], color: "#0b5ed7" }
        ]
      },
      content: [
        { columns: [{ text: "REF NO.: " + jobData.joNumber, bold: true, fontSize: 11 }, { text: "JOB ORDER NO.: " + jobData.joNumber, bold: true, fontSize: 11, alignment: "right" }], margin: [0, 5, 0, 10] },
        { table: { widths: ["*", "*"], body: [[{ text: `Client Name: ${jobData.client}`, fontSize: 10 }, { text: `Address: ${jobData.address}`, fontSize: 10 }], [{ text: `Model: ${jobData.vehicleModel}`, fontSize: 10 }, { text: `Plate No: ${jobData.plateNumber}`, fontSize: 10 }], [{ text: `Date In: ${jobData.dateIn}`, fontSize: 10 }, { text: `Date Out: ${jobData.dateRelease}`, fontSize: 10 }], [{ text: `Customer Type: ${jobData.customerType}`, fontSize: 10 }, { text: `Contact No: ${jobData.contactNumber}`, fontSize: 10 }]] }, layout: "noBorders", margin: [0, 0, 0, 15] },
        { text: "SERVICES", style: "sectitle" },
        { table: { widths: ["*", 40, 40, 60, 60], headerRows: 1, body: [[{ text: "JOB/ITEM DESCRIPTION", bold: true, fontSize: 10 }, { text: "QNT", bold: true, alignment: "center", fontSize: 10 }, { text: "UNIT", bold: true, alignment: "center", fontSize: 10 }, { text: "AMOUNT", bold: true, alignment: "right", fontSize: 10 }, { text: "TOTAL AMOUNT", bold: true, alignment: "right", fontSize: 10 }], ...serviceRows] }, margin: [0, 0, 0, 10] },
        { text: "PARTS", style: "sectitle" },
        { table: { widths: ["*", 40, 40, 60, 60], headerRows: 1, body: [[{ text: "DESCRIPTION", bold: true, fontSize: 10 }, { text: "QNT", bold: true, alignment: "center", fontSize: 10 }, { text: "UNIT", bold: true, alignment: "center", fontSize: 10 }, { text: "AMOUNT", bold: true, alignment: "right", fontSize: 10 }, { text: "TOTAL AMOUNT", bold: true, alignment: "right", fontSize: 10 }], ...partsRows] }, margin: [0, 0, 0, 15] },
        { text: `Mechanical/Technician: ${jobData.assignedTo}`, fontSize: 10, margin: [0, 0, 0, 15] },
        { text: `Subtotal: ₱${jobData.subtotal.toFixed(2)}`, alignment: "right", fontSize: 10 },
        { text: `Total: ₱${jobData.grandTotal.toFixed(2)}`, bold: true, alignment: "right", fontSize: 11, margin: [0, 0, 0, 20] }
      ],

      footer: function (currentPage, pageCount) {
        return {
          margin: [40, 20, 40, 40],
          stack: [
            {
              columns: [
                {
                  width: "50%",
                  stack: [
                    { text: "Chief Mechanic:", fontSize: 9, italics: true },
                    { text: "Leo Palmero", fontSize: 10, bold: true, italics: true }
                  ],
                  alignment: "center"
                },
                {
                  width: "50%",
                  stack: [
                    { text: "Prepared By:", fontSize: 9, italics: true },
                    { text: "Carmela Angulo", fontSize: 10, bold: true, italics: true }
                  ],
                  alignment: "center"
                }
              ]
            },

            { text: "", margin: [0, 10] },

            {
              text: "Note: I hereby acknowledge that all items and labor are in good condition/s",
              fontSize: 9
            },

            { text: "Received By:", fontSize: 10, margin: [0, 12, 0, 6] },
            { text: "_____________________________", fontSize: 10 },

            {
              text: `Page ${currentPage} of ${pageCount}`,
              alignment: "right",
              fontSize: 8,
              margin: [0, 10, 0, 0],
              color: "#666"
            }
          ]
        };
      },
      styles: { header: { fontSize: 16, bold: true }, subheader: { fontSize: 10 }, sectitle: { fontSize: 11, bold: true, margin: [0, 5, 0, 5] } }
    };

    pdfMake.createPdf(docDefinition)
      .download(`JOB-ORDER-${jobData.joNumber}.pdf`);

    if (shouldComplete) {
      setStatus("Completed");
      await persistJobOrder("Completed");
    }
  };

  const loadBase64Image = (url) => {
    return new Promise((resolve) => {
      const reader = new FileReader();
      fetch(url)
        .then(res => res.blob())
        .then(blob => {
          reader.onloadend = () => resolve(reader.result);
          reader.readAsDataURL(blob);
        });
    });
  };

  const todayKey = new Date().toISOString().slice(0, 10);
  const currentYear = todayKey.slice(0, 4);
  const totalSales = completedOrders.reduce((sum, o) => {
    const dateKey = (o.dateIn || o.date || "").slice(0, 10);
    if (!dateKey.startsWith(currentYear)) return sum;
    return sum + (parseFloat(o.total || o.total_amount || 0) || 0);
  }, 0);
  const dailySales = completedOrders.reduce((sum, o) => {
    const dateKey = (o.dateIn || o.date || "").slice(0, 10);
    if (dateKey !== todayKey) return sum;
    return sum + (parseFloat(o.total || o.total_amount || 0) || 0);
  }, 0);
  const dailyProfit = completedOrders.reduce((sum, o) => {
    const dateKey = (o.dateIn || o.date || "").slice(0, 10);
    if (dateKey !== todayKey) return sum;
    const totals = computeOrderTotals(o);
    return sum + totals.profit;
  }, 0);

  const filteredProducts = products.filter((p) => {
    if (!inventorySearch.trim()) return true;
    const q = inventorySearch.trim().toLowerCase();
    return [
      p.code,
      p.part_number,
      p.partNumber,
      p.name,
      p.description,
      p.company_codename,
      p.status
    ].some((v) => String(v || "").toLowerCase().includes(q));
  });

  const filteredJobOrders = jobOrders.filter((o) => {
    if (!jobSearch.trim()) return true;
    const q = jobSearch.trim().toLowerCase();
    return [
      o.joNumber,
      o.job_order_no,
      o.client,
      o.customer_name,
      o.vehicleModel,
      o.model,
      o.plate,
      o.plate_no,
      o.status,
      o.assignedTo,
      o.assigned_to
    ].some((v) => String(v || "").toLowerCase().includes(q));
  });

  if (loading) {
    return <div style={{ padding: '40px', textAlign: 'center' }}>Loading...</div>;
  }

  return (
    <div className="admin-container">
      <header className="admin-header">
        <div className="content">
          <div className="left">
            <img src={logoSrc} className="admin-logo" alt="Autronicas logo" />
          </div>
          <nav className="admin-nav">
            <button className={activeTab === "dashboard" ? "active" : ""} onClick={() => setActiveTab("dashboard")}>Dashboard</button>
            <button className={activeTab === "inventory" ? "active" : ""} onClick={() => setActiveTab("inventory")}>Inventory</button>
            <button className={activeTab === "jobs" ? "active" : ""} onClick={() => setActiveTab("jobs")}>Job Orders</button>
            <button className={activeTab === "sales" ? "active" : ""} onClick={() => setActiveTab("sales")}>Sales</button>
            <button className="logout" onClick={handleLogout}>Logout</button>
          </nav>
        </div>
      </header>

      <div className="dashboard-content">
        {activeTab === "dashboard" && (
          <>
            <h2>Dashboard Overview</h2>
            <div className="cards-grid">
              <div className="card blue">
                <p className="card-title">Total Products</p>
                <h1 className="card-value">{dashboardStats?.total_products || products.length}</h1>
              </div>
              <div className="card purple">
                <p className="card-title">Total Jobs</p>
                <h1 className="card-value">{dashboardStats?.total_jobs || jobOrders.length}</h1>
              </div>
              <div className="card green">
                <p className="card-title">Total Sales</p>
                <h1 className="card-value">₱{totalSales.toFixed(2)}</h1>
                <p className="card-subvalue">Total Profit: ₱{totalProfit.toFixed(2)}</p>
              </div>
              <div className="card green">
                <p className="card-title">Daily Sales</p>
                <h1 className="card-value">₱{dailySales.toFixed(2)}</h1>
                <p className="card-subvalue">Daily Profit: ₱{dailyProfit.toFixed(2)}</p>
              </div>
            </div>
          </>
        )}

        {activeTab === "inventory" && (
          <>
            <div className="inventory-header">
              <h2>Inventory Management</h2>
              <button className="add-product-btn" onClick={() => { setNewProduct({ code: "", partNumber: "", name: "", quantity: "", price: "", srp: "", companyCodename: "" }); setShowModal(true); }}>Add Product</button>
            </div>
            <div className="inventory-search">
              <input
                className="search-input"
                type="text"
                placeholder="Search inventory..."
                value={inventorySearch}
                onChange={(e) => setInventorySearch(e.target.value)}
              />
            </div>
            <table className="inventory-table">
              <thead>
                <tr>
                  <th>CODE</th>
                  <th>PART NUMBER</th>
                  <th>PRODUCT</th>
                  <th>STOCKS</th>
                  <th>COMPANY</th>
                  <th>STATUS</th>
                  <th>UNIT PRICE</th>
                  <th>PRIVATE SRP</th>
                  <th>LGU SRP</th>
                  <th>STAN SRP</th>
                  <th>ACTIONS</th>
                </tr>
              </thead>
              <tbody>
                {filteredProducts.length === 0 ? (
                  <tr><td colSpan="11" className="empty-message">No products added yet.</td></tr>
                ) : (
                  filteredProducts.map((p) => (
                    <tr key={p.id}>
                      <td>{p.code}</td>
                      <td>{p.part_number || p.partNumber || '-'}</td>
                      <td>{p.name}</td>
                      <td>{p.stocks}</td>
                      <td>{p.company_codename || '-'}</td>
                      <td>
                        <span className={p.status === "Out of Stock" ? "status-tag red" : "status-tag green"}>
                          {p.status}
                        </span>
                      </td>
                      <td>₱{parseFloat(p.price).toFixed(2)}</td>
                      <td>₱{(parseFloat(p.price || 0) * 1.25 * 1.12).toFixed(2)}</td>
                      <td>₱{(parseFloat(p.price || 0) * 1.60 * 1.12).toFixed(2)}</td>
                      <td>₱{(parseFloat(p.price || 0) * 1.30 * 1.12).toFixed(2)}</td>
                      <td>
                        <button className="edit-btn" onClick={() => openEditModal(p.id)}>Edit</button>
                        <button className="delete-btn" onClick={() => handleDeleteProduct(p.id)}>Delete</button>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </>
        )}

        {activeTab === "jobs" && (
          <div className="joborders-section">
            <div className="joborders-header">
              <h2>Job Order Management</h2>
              <button className="create-joborder-btn" onClick={() => { resetJobForm(); setEditJobId(null); setShowJobOrderModal(true); }}>Create New Job Order</button>
            </div>
            <div className="joborders-search">
              <input
                className="search-input"
                type="text"
                placeholder="Search job orders..."
                value={jobSearch}
                onChange={(e) => setJobSearch(e.target.value)}
              />
            </div>
            <div className="joborders-filters">
              <button className={jobStatusFilter === "All" ? "active" : ""} onClick={() => setJobStatusFilter("All")}>All</button>
              <button className={jobStatusFilter === "Pending" ? "active" : ""} onClick={() => setJobStatusFilter("Pending")}>Pending</button>
              <button className={jobStatusFilter === "In Progress" ? "active" : ""} onClick={() => setJobStatusFilter("In Progress")}>In Progress</button>
              <button className={jobStatusFilter === "Completed" ? "active" : ""} onClick={() => setJobStatusFilter("Completed")}>Completed</button>
            </div>
            <div className="joborders-table-wrapper">
              <table className="joborders-table">
                <thead>
                  <tr>
                    <th>JOB ORDER NO.</th>
                    <th>CLIENT NAME</th>
                    <th>VEHICLE MODEL</th>
                    <th>PLATE NUMBER</th>
                    <th>TOTAL PRICE</th>
                    <th>STATUS</th>
                    <th>ASSIGNED TO</th>
                    <th>DATE IN</th>
                    <th>DATE RELEASE</th>
                    <th>ACTIONS</th>
                  </tr>
                </thead>
                <tbody>
                  {filteredJobOrders.filter(o => jobStatusFilter === "All" || o.status === jobStatusFilter).length === 0 ? (
                    <tr><td colSpan="10" className="empty-message">No job orders created yet.</td></tr>
                  ) : (
                    filteredJobOrders
                      .filter(o => jobStatusFilter === "All" || o.status === jobStatusFilter)
                      .map((o) => (
                      <tr key={o.id}>
                        <td>{formatJobOrderNo(o.joNumber || o.job_order_no)}</td>
                        <td>{o.client || o.customer_name}</td>
                        <td>{o.vehicleModel || o.model}</td>
                        <td>{o.plate || o.plate_no}</td>
                        <td>₱{Number(o.total || o.total_amount || 0).toFixed(2)}</td>
                        <td>
                          <span className={o.status === "Pending" ? "status-tag yellow" : o.status === "In Progress" ? "status-tag blue" : "status-tag green"}>{o.status}</span>
                        </td>
                        <td>{o.assignedTo || o.assigned_to}</td>
                        <td>{o.dateIn || o.date}</td>
                        <td>{o.dateRelease || o.date_release || '-'}</td>
                        <td className="actions">
                          <button className="view-edit-btn" onClick={() => handleEditJob(o.id)}>
                            {o.status === "Completed" ? "View/Print" : "Edit"}
                          </button>
                          <button className="delete-btn" onClick={() => handleDeleteJobOrder(o.id)} style={{ marginLeft: 8 }}>Delete</button>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {activeTab === "sales" && (
          <div className="sales-section">
            <h2>Sales Management</h2>
            <div className="sales-cards">
              <div className="sales-card">
                <h4>Daily Summary Report</h4>
                <p>Total Sales: ₱{dailySales.toFixed(2)}</p>
                <p>Total Profit: ₱{dailyProfit.toFixed(2)}</p>
              </div>
              <div className="sales-card">
                <h4>View Sales by Date</h4>
                <input type="date" value={salesDate} onChange={(e) => setSalesDate(e.target.value)} />
                <p>Showing sales for: {salesDate || "-"}</p>
                <p>Total Sales: ₱{totalSalesByDate.toFixed(2)}</p>
                <p>Total Profit: ₱{totalProfitByDate.toFixed(2)}</p>
              </div>
              <div className="sales-card">
                <h4>Sales by Date Range</h4>
                <div className="sales-range">
                  <label>Start:</label>
                  <input type="date" value={salesStartDate} onChange={(e) => setSalesStartDate(e.target.value)} />
                  <label>End:</label>
                  <input type="date" value={salesEndDate} onChange={(e) => setSalesEndDate(e.target.value)} />
                </div>
                <p>Total: ₱{totalSalesByRange.toFixed(2)}</p>
                <p>Total Profit: ₱{totalProfitByRange.toFixed(2)}</p>
              </div>
            </div>

            <div className="sales-log-header">
              <h3>Sales Log</h3>
              <div className="sales-log-actions">
                <div className="sales-filter">
                  <label>Date:</label>
                  <input type="date" value={salesLogDate} onChange={(e) => setSalesLogDate(e.target.value)} />
                </div>
              </div>
            </div>
            <div className="sales-table-wrapper">
              <table className="sales-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Job Order No.</th>
                    <th>Vehicle / Plate No.</th>
                    <th>Total Service (₱)</th>
                    <th>Total Parts Price (₱)</th>
                    <th>Unit Price (₱)</th>
                    <th>Discount (₱)</th>
                    <th>Total Amount (₱)</th>
                    <th>Profit (₱)</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {filteredSalesOrders.length === 0 ? (
                    <tr><td colSpan="9" className="empty-message">No sales records yet.</td></tr>
                  ) : (
                    filteredSalesOrders.map((o) => {
                      const totals = computeOrderTotals(o);
                      return (
                        <tr key={`sales-${o.id}`}>
                          <td>{toDateKey(getOrderDate(o)) || "-"}</td>
                          <td>{formatJobOrderNo(o.joNumber || o.job_order_no)}</td>
                          <td>{o.vehicleModel || o.model || "-"} / {o.plate || o.plate_no || "-"}</td>
                          <td>₱{totals.totalLabor.toFixed(2)}</td>
                          <td>₱{totals.totalPartsPrice.toFixed(2)}</td>
                          <td>₱{totals.unitPriceTotal.toFixed(2)}</td>
                          <td>₱{totals.discountValue.toFixed(2)}</td>
                          <td>₱{totals.totalAmount.toFixed(2)}</td>
                          <td>₱{totals.profit.toFixed(2)}</td>
                          <td>
                            <span className={o.status === "Pending" ? "status-tag yellow" : o.status === "In Progress" ? "status-tag blue" : "status-tag green"}>
                              {o.status}
                            </span>
                          </td>
                        </tr>
                      );
                    })
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {showJobOrderModal && (
          <div className="joborder-overlay">
            <div className="joborder-modal">
              <div className="modal-header">
                <p className="joborder-inline"><strong>
                  Job Order No. {formatJobOrderNo(
                    editJobId !== null
                      ? jobOrders.find(j => j.id === editJobId)?.joNumber ?? 0
                      : jobOrderNo
                  )}
                </strong>
                </p>
                <button className="export-btn" onClick={exportJobOrderPDF} disabled={!isJobFormValid()}>Export as PDF</button>
              </div>

              <div className="modal-body">
                <div className="form-grid">
                  <div className="left">
                    <label>Client Name</label>
                    <input type="text" placeholder="Enter client name" value={clientName} onChange={(e) => setClientName(e.target.value)} disabled={isJobReadOnly} />
                    <label>Address</label>
                    <input type="text" placeholder="Enter address" value={address} onChange={(e) => setAddress(e.target.value)} disabled={isJobReadOnly} />
                    <label>Vehicle Model</label>
                    <input type="text" placeholder="Enter vehicle model" value={vehicleModel} onChange={(e) => setVehicleModel(e.target.value)} disabled={isJobReadOnly} />
                    <label>Date In</label>
                    <input type="date" value={dateIn} onChange={(e) => setDateIn(e.target.value)} disabled={isJobReadOnly} />
                    <label>Assigned To</label>
                    <select value={assignedTo} onChange={(e) => setAssignedTo(e.target.value)} disabled={isJobReadOnly}>
                      <option value="">Select</option>
                      <option value="Technician A">Technician A</option>
                      <option value="Technician B">Technician B</option>
                      <option value="Technician C">Technician C</option>
                      <option value="Mechanic 1">Mechanic 1</option>
                      <option value="Mechanic 2">Mechanic 2</option>
                    </select>
                  </div>
                  <div className="right">
                    <label>Customer Type</label>
                    <select value={customerType} onChange={(e) => setCustomerType(e.target.value)} disabled={isJobReadOnly}>
                      <option value="">Select</option>
                      <option value="Private">Private</option>
                      <option value="LGU">LGU</option>
                      <option value="STAN">STAN</option>
                    </select>
                    <label>Contact Number</label>
                    <input type="text" placeholder="Enter contact number" value={contactNumber} onChange={(e) => setContactNumber(e.target.value)} disabled={isJobReadOnly} />
                    <label>Plate Number</label>
                    <input type="text" placeholder="Enter plate number" value={plateNumber} onChange={(e) => setPlateNumber(e.target.value)} disabled={isJobReadOnly} />
                    <label>Date Release</label>
                    <input type="date" value={dateRelease} onChange={(e) => setDateRelease(e.target.value)} disabled={isJobReadOnly} />
                    <label>Status</label>
                    <select value={status} onChange={(e) => setStatus(e.target.value)} disabled={isJobReadOnly}>
                      <option>Pending</option>
                      <option>In Progress</option>
                      <option>Completed</option>
                    </select>
                  </div>
                </div>

                <h3 className="section-title">Services</h3>
                <div className="table-headers services-head">
                  <span>Description</span><span>Unit</span><span>Qty</span><span>Price (PHP)</span><span>Total Price (PHP)</span><span></span>
                </div>
                {services.map((s, i) => (
                  <div className="item-row services-row" key={`s-${i}`}>
                    <input type="text" placeholder="Description" value={s.description} onChange={(e) => updateService(i, "description", e.target.value)} disabled={isJobReadOnly} />
                    <input type="text" placeholder="Unit" value={s.unit} onChange={(e) => updateService(i, "unit", e.target.value)} disabled={isJobReadOnly} />
                    <input type="number" min="0" placeholder="Qty" value={s.qty} onChange={(e) => updateService(i, "qty", e.target.value)} disabled={isJobReadOnly} />
                    <input type="number" min="0" step="0.01" placeholder="Price" value={s.unitPrice} onChange={(e) => updateService(i, "price", e.target.value)} onFocus={(e) => e.target.select()} disabled={isJobReadOnly} />
                    <input type="number" min="0" step="0.01" placeholder="Total Price" value={s.price} />
                    <button className="delete-box" onClick={() => deleteService(i)} aria-label="Delete service" disabled={isJobReadOnly}>✕</button>
                  </div>
                ))}
                <button className="small-btn" onClick={addServiceRow} disabled={isJobReadOnly}>+ Add Service</button>

                <h3 className="section-title">Parts</h3>
                <div className="table-headers parts-head">
                  <span>Description</span><span>Unit</span><span>Qty</span><span>Price (PHP)</span><span>Total Price (PHP)</span><span></span>
                </div>
                {parts.map((p, i) => (
                  <div className="item-row parts-row" key={`p-${i}`}>
                    <input
                      type="text"
                      placeholder="Description"
                      value={p.description}
                      onChange={(e) => updatePart(i, "description", e.target.value)}
                      onKeyDown={(e) => {
                        if (e.key === "Enter") {
                          e.preventDefault();
                          updatePart(i, "description", e.currentTarget.value, { commit: true });
                        }
                      }}
                      disabled={isJobReadOnly}
                    />
                    <input type="text" placeholder="Unit" value={p.unit} onChange={(e) => updatePart(i, "unit", e.target.value)} disabled={isJobReadOnly} />
                    <input type="number" min="0" placeholder="Qty" value={p.qty} onChange={(e) => updatePart(i, "qty", e.target.value)} disabled={isJobReadOnly} />
                    <input type="number" min="0" step="0.01" placeholder="Price" value={p.unitPrice} onChange={(e) => updatePart(i, "price", e.target.value)} onFocus={(e) => e.target.select()} disabled={isJobReadOnly} />
                    <input type="number" min="0" step="0.01" placeholder="Total Price" value={p.price} />
                    <button className="delete-box" onClick={() => deletePart(i)} aria-label="Delete part" disabled={isJobReadOnly}>✕</button>
                  </div>
                ))}
                <button className="small-btn" onClick={addPartRow} disabled={isJobReadOnly}>+ Add Part</button>

                <hr />
                <div className="totals">
                  <p>Subtotal: ₱{Number(subtotal).toFixed(2)}</p>
                  <p>
                    Discount: ₱
                    <input
                      type="number"
                      min="0"
                      step="0.01"
                      placeholder="0.00"
                      value={discount}
                      onChange={(e) => setDiscount(e.target.value)}
                      style={{ width: 120, marginLeft: 6 }}
                      disabled={isJobReadOnly}
                    />
                  </p>
                  <p><b>Total: ₱{Number(grandTotal).toFixed(2)}</b></p>
                </div>
              </div>

              <div className="modal-footer" style={{ justifyContent: "flex-end", gap: 12 }}>
                <button className="footer-btn back" onClick={() => { setShowJobOrderModal(false); setEditJobId(null); resetJobForm(); }}>Cancel</button>
                <button className="footer-btn finalize" onClick={saveJobOrder} disabled={!isJobFormValid() || isJobReadOnly}>Save</button>
              </div>
            </div>
          </div>
        )}

        {showModal && (
          <div className="modal-container">
            <div className="modal-box">
              <h2>Add New Product</h2>

              <label>Code (Barcode)</label>
              <input
                type="text"
                placeholder="Scan or enter code"
                value={newProduct.code}
                onChange={(e) => setNewProduct({ ...newProduct, code: e.target.value })}
                autoFocus
              />

              <label>Part Number</label>
              <input
                type="text"
                placeholder="Enter part number"
                value={newProduct.partNumber}
                onChange={(e) => setNewProduct({ ...newProduct, partNumber: e.target.value })}
              />

              <label>Product Name</label>
              <input type="text" placeholder="Enter Product Name" value={newProduct.name} onChange={(e) => setNewProduct({ ...newProduct, name: e.target.value })} />
              <label>Company</label>
              <input type="text" placeholder="Enter company name" value={newProduct.companyCodename} onChange={(e) => setNewProduct({ ...newProduct, companyCodename: e.target.value })} />
              <label>Quantity</label>
              <input type="number" placeholder="Enter Quantity" value={newProduct.quantity} onChange={(e) => setNewProduct({ ...newProduct, quantity: e.target.value })} />
              <label>Unit Price</label>
              <input type="number" placeholder="Enter Unit Price" step="0.01" value={newProduct.price} onChange={(e) => setNewProduct({ ...newProduct, price: e.target.value })} />
              <div className="modal-actions">
                <button className="cancel" onClick={() => setShowModal(false)}>Cancel</button>
                <button className="save" disabled={!isFormValid()} onClick={handleAddProduct}>Save</button>
              </div>
            </div>
          </div>
        )}

        {isEditModal && (
          <div className="modal-container">
            <div className="modal-box">
              <h2>Edit Product</h2>
              <label>Code</label>
              <input type="text" value={newProduct.code} onChange={(e) => setNewProduct({ ...newProduct, code: e.target.value })} />
              <label>Part Number</label>
              <input type="text" value={newProduct.partNumber} onChange={(e) => setNewProduct({ ...newProduct, partNumber: e.target.value })} />
              <label>Product Name</label>
              <input type="text" value={newProduct.name} onChange={(e) => setNewProduct({ ...newProduct, name: e.target.value })} />
              <label>Company</label>
              <input type="text" value={newProduct.companyCodename} onChange={(e) => setNewProduct({ ...newProduct, companyCodename: e.target.value })} />
              <label>Quantity</label>
              <input type="number" value={newProduct.quantity} onChange={(e) => setNewProduct({ ...newProduct, quantity: e.target.value })} />
              <label>Unit Price</label>
              <input type="number" step="0.01" value={newProduct.price} onChange={(e) => setNewProduct({ ...newProduct, price: e.target.value })} />
              <div className="modal-actions">
                <button className="cancel" onClick={() => { setIsEditModal(false); setEditProductId(null); }}>Cancel</button>
                <button className="save" disabled={!isFormValid()} onClick={handleSaveEdit}>Save Changes</button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

export default AdminDashboard;
